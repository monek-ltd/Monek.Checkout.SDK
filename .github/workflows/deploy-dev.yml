name: Deploy SDK to Dev

on:
  workflow_dispatch:
  pull_request:
    branches:
      - main
    types:      
      - opened
      - synchronize
      - reopened

env:
  AWS_REGION: eu-west-2
  NODE_VERSION: 22.x
  PIPELINE_EXECUTION_ROLE: arn:aws:iam::524429825864:role/GitHub-Actions-Dev-Workflow
  CLOUDFORMATION_EXECUTION_ROLE: arn:aws:iam::524429825864:role/GitHub-CloudFormation-Dev-Execution
  SDK_BUCKET: dev-checkout-js.monek.com

jobs:
  Build-SDK:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: EmbeddedCheckout/SDK/package-lock.json
          
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
            audience: sts.amazonaws.com
            aws-region: ${{ env.AWS_REGION }}
            role-to-assume: ${{ env.PIPELINE_EXECUTION_ROLE }}
            role-session-name: feature-deployment
            role-duration-seconds: 3600
            role-skip-session-tagging: true

      - name: Install dependencies
        continue-on-error: true
        working-directory: EmbeddedCheckout/SDK
        run: npm install
          
      - name: Build
        working-directory: EmbeddedCheckout/SDK
        run: npm run build
          
      - name: Deploy
        run: aws s3 sync ./EmbeddedCheckout/SDK/dist s3://${{ env.SDK_BUCKET }} --delete