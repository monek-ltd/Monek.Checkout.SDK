<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>SDK Dev Dashboard</title>
</head>
<body>
    <h1>Monek Checkout SDK — Dev Dashboard</h1>

    <h2>Test Checkout (SDK-mounted)</h2>
    <form id="test-form" action="/echo" method="POST">

        <!-- Cardholder Name -->
        <label>
            Name on Card
            <input type="text" name="billingName" autocomplete="cc-name" required />
        </label>

        <!-- Email -->
        <label>
            Email
            <input type="email" name="billingEmail" autocomplete="email" required />
        </label>

        <!-- Phone -->
        <label>
            Phone
            <input type="tel" name="billingPhone" autocomplete="tel" />
        </label>

        <!-- Address lines -->
        <label>
            Address Line 1
            <input type="text" name="billingAddress1" autocomplete="address-line1" required />
        </label>

        <label>
            Address Line 2
            <input type="text" name="billingAddress2" autocomplete="address-line2" />
        </label>

        <!-- City -->
        <label>
            City
            <input type="text" name="billingCity" autocomplete="address-level2" required />
        </label>

        <!-- Postcode -->
        <label>
            Postcode
            <input type="text" name="billingPostcode" autocomplete="postal-code" required />
        </label>

        <!-- Country (numeric code or ISO alpha-2, depending on your API) -->
        <label>
            Country
            <input type="text" name="billingCountry" placeholder="826" required />
        </label>

        <div id="sdk-container" style="border:1px dashed #ccc; padding:8px;" width="100%" height="120"></div>
        <button type="submit">Pay</button>
    </form>

    <hr />

    <h2>Hosted Fields (raw iframe preview)</h2>
    <iframe id="hf" src="/src/hostedFields/hosted-fields.html"
            width="100%" height="120" style="border:1px solid #eee"></iframe>

    <h2>Express Checkout</h2>
    <iframe id="express" src="/src/expressCheckout/express-checkout.html"
            width="100%" height="80" style="border:1px solid #eee"></iframe>

    <!-- The built SDK (IIFE). -->
    <script src="/monek-checkout.iife.js"></script>
    <script>
        (async function () {
            // ====== debug taps ======
            window.addEventListener('message', (evt) => {
                console.log('[PARENT RX]', evt.origin, evt.data);
            });
            console.log('[parent] origin =', window.location.origin);

            // ====== init SDK ======
            const PUBLIC_KEY = 'live_433834c4d38943049107fb5be88a62ea'; // <-- set your dev key
            if (typeof window.Monek !== 'function') {
                console.error('Monek SDK not loaded');
                return;
            }
            const sdk = await window.Monek(PUBLIC_KEY);
            
            const formEl = document.getElementById('test-form');

            // ====== mount checkout via SDK ======
            const checkout = sdk.createComponent('checkout', {
                frameUrl: 'https://dev-checkout-js.monek.com/src/hostedFields/hosted-fields.html', //Change to dev for testing
                callbacks: {
                  getAmount: () => ({ value: 1000, currencyCode: '826' }),
                  getCardholderDetails: () => {
                    const fd = new FormData(formEl);
                    console.log("Fetching form data.")

                    return {
                      name: fd.get('billingName'),
                      email: fd.get('billingEmail'),
                      HomePhone: fd.get('billingPhone'),
                      billingAddress: {
                        addressLine1: fd.get('billingAddress1'),
                        addressLine2: fd.get('billingAddress2'),
                        city: fd.get('billingCity'),
                        postcode: fd.get('billingPostcode'),
                        country: fd.get('billingCountry'),
                      }
                    };
                  },
                    getDescription: () => 'goods',

                    challenge: { display: 'popup', size: 'medium' },

                    completion: {
                        mode: 'client', // 'client' = SDK calls /payment; 'form' = merchant server will

                        // onSuccess can be:
                        //   1) redirect object,
                        //   2) function(ctx, helpers) { ...; return string|Redirect; } or do nothing,
                        //   3) undefined (SDK falls back to posting the form)
                        onSuccess: (ctx, { redirect }) => {
                            console.log('[completion] success ctx:', ctx);
                            // Return a URL string for convenience redirect:
                            return `/thank-you?s=${encodeURIComponent(ctx.sessionId)}`;
                        },

                        // onError can re-enable UI, show message, or redirect somewhere:
                        onError: (ctx, { reenable }) => {
                            console.warn('[completion] error ctx:', ctx);
                            reenable();
                            alert(ctx?.payment?.Message || 'Payment failed. Please try another card.');
                            // or: return { url:'/payment-error', method:'GET', parameters:{ s: ctx.sessionId } };
                        },

                        // onCancel (challenge closed by user) → keep shopper on page
                        onCancel: (ctx, { reenable }) => {
                            console.log('[completion] cancel ctx:', ctx);
                            reenable();
                        },
                    },
                }
              });

            checkout.mount('#sdk-container'); 
        })();
    </script>
</body>
</html>
